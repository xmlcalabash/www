<?xml-stylesheet type="text/xsl" href="/style/testcase.xsl"?>
<t:test xmlns:t="http://xproc.org/ns/testsuite"
        xmlns:p="http://www.w3.org/ns/xproc"
        xmlns:c="http://www.w3.org/ns/xproc-step"
        xmlns:j="http://marklogic.com/json"
        xmlns:err="http://www.w3.org/ns/xproc-error">

<!-- N.B. This test only works if transparent-json is disabled -->

<t:title>Test http-request binary #001</t:title>

<t:pipeline>
<p:declare-step version='1.0' name="main">
  <p:output port="result"/>
  <p:documentation>
    This test posts three bytes to an echo server on the internet.
    The bytes sent have identical values (181 = 0xB5).
    The byte sequence 0xB5 0xB5 0xB5 encoded in base64 = "tbW1".
  </p:documentation>
  <p:http-request name="post-three-bytes">
    <p:input port="source">
      <p:inline>
        <c:request href="http://echo.getpostman.com/post" method="POST">
          <c:body content-type="application/octet-stream" encoding="base64">
            tbW1
          </c:body>
        </c:request>
      </p:inline>
    </p:input>
    <p:log port="result" href="/tmp/out.xml"/>
  </p:http-request>
  <p:unescape-markup name="parse-json-response">
    <p:with-option name="content-type" select="/c:body/@content-type"/>
    <p:with-option name="encoding" select="/c:body/@encoding"/>
  </p:unescape-markup>
  <p:template name="list-content-bytes-echoed-from-server">
    <p:with-param name="bytes"
                  select="string-join(/c:body/j:json/j:data/j:data/j:item, ', ')"/>
    <p:input port="template">
      <p:inline exclude-inline-prefixes="c j">
        <bytes>{$bytes}</bytes>
      </p:inline>
    </p:input>
  </p:template>
</p:declare-step>
</t:pipeline>

<t:output port='result'>
<bytes>181, 181, 181</bytes>
</t:output>

</t:test>
